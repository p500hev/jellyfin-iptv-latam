name: Actualizar TecnoTV Code

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Buscar nuevo c√≥digo y actualizar Latino3.m3u
        id: update
        run: |
          python << 'PYEOF'
          import re
          import requests
          from datetime import datetime
          import os

          URL_PAGINA = "https://spinoff.link/listas-iptv-actualizadas-2025/"
          PATRON = r'http://tecnotv\.club/([a-z0-9]+)/lista2\.m3u'
          ARCHIVO_M3U = "Latino3.m3u"
          ARCHIVO_VERSION = "ultima_version.txt"

          def obtener_codigo_actual():
              if os.path.exists(ARCHIVO_VERSION):
                  with open(ARCHIVO_VERSION, 'r', encoding='utf-8') as f:
                      return f.read().strip()
              return "06fb"

          def obtener_nuevo_codigo():
              try:
                  headers = {'User-Agent': 'Mozilla/5.0'}
                  response = requests.get(URL_PAGINA, headers=headers, timeout=15)
                  response.raise_for_status()
                  
                  match = re.search(PATRON, response.text)
                  if match:
                      return match.group(1)
                  else:
                      print("‚ùå No se encontr√≥ el patr√≥n en la p√°gina")
                      return None
              except Exception as e:
                  print(f"‚ùå Error al obtener la p√°gina: {e}")
                  return None

          def actualizar_archivo_m3u(codigo_viejo, codigo_nuevo):
              if not os.path.exists(ARCHIVO_M3U):
                  print(f"‚ùå Archivo {ARCHIVO_M3U} no encontrado")
                  return False, 0

              with open(ARCHIVO_M3U, 'r', encoding='utf-8') as f:
                  contenido = f.read()

              url_vieja = f'http://tecnotv.club/{codigo_viejo}/'
              url_nueva = f'http://tecnotv.club/{codigo_nuevo}/'
              
              conteo = contenido.count(url_vieja)
              
              if conteo == 0:
                  print(f"‚ö†Ô∏è No se encontraron URLs con el c√≥digo '{codigo_viejo}'")
                  return False, 0

              contenido_nuevo = contenido.replace(url_vieja, url_nueva)

              with open(ARCHIVO_M3U, 'w', encoding='utf-8') as f:
                  f.write(contenido_nuevo)

              with open(ARCHIVO_VERSION, 'w', encoding='utf-8') as f:
                  f.write(codigo_nuevo)

              print(f"‚úÖ Actualizado: {conteo} URLs reemplazadas")
              print(f"   {url_vieja} ‚Üí {url_nueva}")
              return True, conteo

          print(f"üïê Verificaci√≥n iniciada: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

          codigo_actual = obtener_codigo_actual()
          print(f"üîç C√≥digo actual guardado: {codigo_actual}")

          codigo_nuevo = obtener_nuevo_codigo()
          if not codigo_nuevo:
              print("‚ö†Ô∏è No se pudo obtener el nuevo c√≥digo. Abortando.")
              exit(0)

          print(f"üÜï Nuevo c√≥digo detectado: {codigo_nuevo}")

          if codigo_actual == codigo_nuevo:
              print("‚úÖ El c√≥digo no ha cambiado. No se requiere actualizaci√≥n.")
              exit(0)

          print(f"üîÑ ¬°Cambio detectado! Actualizando...")
          actualizado, canales = actualizar_archivo_m3u(codigo_actual, codigo_nuevo)

          if actualizado:
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as gh_out:
                  gh_out.write(f"actualizado=true\n")
                  gh_out.write(f"canales={canales}\n")
                  gh_out.write(f"codigo_viejo={codigo_actual}\n")
                  gh_out.write(f"codigo_nuevo={codigo_nuevo}\n")
              
              print(f"‚úÖ Archivo {ARCHIVO_M3U} actualizado correctamente")
          else:
              print("‚ö†Ô∏è No se realizaron cambios en el archivo")
          PYEOF

      - name: Commit y push si hay cambios
        if: steps.update.outputs.actualizado == 'true'
        run: |
          # Configura el usuario de Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # üîë FIX: Configura el remote URL con el token (esto resuelve el error 403)
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Agrega los cambios y commit
          git add Latino3.m3u ultima_version.txt
          git commit -m "üîÑ TecnoTV: ${{ steps.update.outputs.codigo_viejo }} ‚Üí ${{ steps.update.outputs.codigo_nuevo }} | ${{ steps.update.outputs.canales }} canales actualizados" \
            -m "Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # Hace el push
          git push

      - name: Resumen
        run: |
          echo "‚úÖ Proceso completado"
          echo "C√≥digo anterior: ${{ steps.update.outputs.codigo_viejo }}"
          echo "C√≥digo nuevo: ${{ steps.update.outputs.codigo_nuevo }}"
          echo "Canales actualizados: ${{ steps.update.outputs.canales }}"
