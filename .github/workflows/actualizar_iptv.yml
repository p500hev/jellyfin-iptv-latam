name: Actualización Automática de Lista LATAM (Final)

# 1. Definición de la Frecuencia
# Ejecutar diariamente a las 00:00 UTC (medianoche)
on:
  schedule:
    - cron: '0 0 * * *' 
  # Permite ejecución manual
  workflow_dispatch:

jobs:
  filtrar_y_actualizar:
    runs-on: ubuntu-latest
    
    # 2. Permisos para que el bot pueda subir el archivo actualizado (SOLUCIONA ERROR 403)
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Descargar Lista Completa de IPTV-ORG (URL Corregida)
        run: |
          # Usamos la URL principal y más estable de IPTV-ORG
          curl -s "https://iptv-org.github.io/iptv/index.m3u" > lista_completa_original.m3u

      - name: Aplicar Filtros (Permitiendo IPs, US y conservando Grupos/EPG)
        run: |
          # ----------------------------------------------------------------------
          # Archivo de destino final
          DEST_FILE="latam.m3u"
          INPUT_FILE="lista_completa_original.m3u"
          # ----------------------------------------------------------------------
          
          # 1. Crear el encabezado M3U
          echo "#EXTM3U" > $DEST_FILE
          
          # 2. Definir la lista de códigos de país a EXCLUIR (Bloqueo estricto de Europa, Asia, etc.)
          # Los códigos latinos (mx, ar, co, etc.) y US NO están en esta lista.
          BLOCK_CODES='es|de|fr|it|uk|ru|cn|jp|kr|th|ae|tv|il|pl|cz|hu|ro|in|pk|bg|al|gr|be|ch|se|no|dk|fi|ie|nl|za|au|nz|ca|ir|eg|ng|ke|sa|tr|rs|ua|sk|hu'

          # 3. Usar AWK para filtrar líneas de forma robusta
          awk -v block_codes="$BLOCK_CODES" '
            /#EXTINF/ {
                header = $0;
                i = 1; # Bandera para saber que la siguiente línea es la URL
                next;
            }
            /http/ && i == 1 {
                # Usamos la lógica de exclusión: si el header NO contiene un código de país bloqueado, se imprime.
                if (header !~ block_codes "@") {
                    print header;
                    print $0; # Imprimir la URL
                }
                i = 0;
            }' "$INPUT_FILE" >> $DEST_FILE
          
      - name: Subir el Archivo Limpio (Sobrescribir latam.m3u)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Actualización automática: Lista LATAM+US(Latino) filtrada y limpia (Manteniendo Grupos)."
          files: latam.m3u
