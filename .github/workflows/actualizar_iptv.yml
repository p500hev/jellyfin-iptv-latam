- name: Descargar, Filtrar y Generar Archivo Final
        run: |
          # ----------------------------------------------------------------------
          DEST_FILE="latam.m3u"
          TEMP_FILTER_FILE="latam_temp.m3u"
          INPUT_FILE="lista_completa_original.m3u"
          # ----------------------------------------------------------------------
          
          echo "# Descargando lista fuente..."
          curl -s "https://iptv-org.github.io/iptv/index.m3u" > $INPUT_FILE

          echo "# Aplicando doble filtro: Inclusión por País y Exclusión por Grupo/País..."
          echo "#EXTM3U" > $TEMP_FILTER_FILE
          
          # CÓDIGOS DE PAÍS QUE QUEREMOS MANTENER (LATAM y US)
          INCLUDE_CODES='mx|ar|co|cl|pe|ec|ve|bo|py|uy|cr|pa|gt|hn|ni|sv|cu|do|pr|us'
          
          # GRUPOS QUE QUEREMOS EXCLUIR
          EXCLUDE_GROUPS='Religious|Shopping|Sales|Infomercial|Adult|Unknown|Geolocked|Arabic|Indian|Pakistani|Australian|Asian|Russian|Turkish|European|XX|News|Sports|VOD'
          
          # CÓDIGOS DE PAÍS ADICIONALES A EXCLUIR EXPLICITAMENTE (Europa, Asia, etc.)
          # Incluye Austria (at) y otros países que deben ser bloqueados
          EXCLUDE_COUNTRY_CODES='es|de|fr|it|uk|ru|cn|jp|kr|th|ae|tv|il|pl|cz|hu|ro|in|pk|bg|al|gr|be|ch|se|no|dk|fi|ie|nl|za|au|nz|ca|ir|eg|ng|ke|sa|tr|rs|ua|sk|hu|at|iq|in'


          # 3. FILTRAR y ESCRIBIR en Temporal (Triple Lógica)
          awk -v include_codes="$INCLUDE_CODES" -v exclude_groups="$EXCLUDE_GROUPS" -v exclude_countries="$EXCLUDE_COUNTRY_CODES" '
            /#EXTINF/ {
                header = $0;
                i = 1; 
                next;
            }
            /http/ && i == 1 {
                # Criterio 1: EXCLUSIÓN por Grupo (Si es Religious, Shopping, etc., se salta)
                if (header ~ "group-title=\"" exclude_groups) {
                    i = 0;
                    next;
                }
                
                # Criterio 2: EXCLUSIÓN por Código de País (Si es at, de, ru, etc., se salta)
                if (header ~ exclude_countries "@") {
                    i = 0;
                    next;
                }
                
                # Criterio 3: INCLUSIÓN (Si NO fue excluido y coincide con un código de país bueno)
                if (header ~ include_codes "@") {
                    print header;
                    print $0;
                }
                i = 0;
            }' "$INPUT_FILE" >> $TEMP_FILTER_FILE

          echo "# Sobrescribiendo archivo de destino final..."
          mv $TEMP_FILTER_FILE $DEST_FILE
