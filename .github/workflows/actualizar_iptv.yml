name: Actualizacion_IPTV_LATAM_Exclusion

on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  filtrar_y_actualizar:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Descargar, Filtrar y Generar Archivo Final
        run: |
          # Variables de archivo
          DEST_FILE="latam.m3u"
          TEMP_FILTER_FILE="latam_temp.m3u"
          INPUT_FILE="lista_completa_original.m3u"
          
          # 1. DESCARGAR FUENTE
          echo "# Descargando lista fuente..."
          curl -s "https://iptv-org.github.io/iptv/index.m3u" > $INPUT_FILE

          # 2. CONFIGURAR FILTROS Y ENCABEZADO
          echo "# Aplicando filtro de Exclusión Global (Paises + Grupos)..."
          echo "#EXTM3U" > $TEMP_FILTER_FILE
          
          # GRUPOS QUE QUEREMOS EXCLUIR ESTRICTAMENTE
          EXCLUDE_GROUPS='Religious|Shopping|Sales|Infomercial|Adult|Unknown|Geolocked|Arabic|Indian|Pakistani|Australian|Asian|Russian|Turkish|European|XX|News|Sports|VOD|Music'
          
          # CÓDIGOS DE PAÍS NO-LATINOAMERICANOS A EXCLUIR (EL MUNDO ENTERO - LATAM)
          # Esto bloquea US, CA, todos los países europeos, Asia, África, Oceanía.
          EXCLUDE_COUNTRY_CODES='us|ca|es|de|fr|it|uk|ru|cn|jp|kr|th|ae|tv|il|pl|cz|hu|ro|in|pk|bg|al|gr|be|ch|se|no|dk|fi|ie|nl|za|au|nz|ir|eg|ng|ke|sa|tr|rs|ua|sk|hu|at|iq|in|my|sg|id|ph|vn|bd|np|lk|et|gh|tz|ug|ke|zw|zm|pt|gr|ie|is|cy|mt|lt|lv|ee|by|md|ba|hr|me|mk|dk|no|se|fi|is|li|lu|mc|ad|sm|va'


          # 3. FILTRAR y ESCRIBIR en Temporal (Doble Lógica de Exclusión)
          awk -v exclude_groups="$EXCLUDE_GROUPS" -v exclude_countries="$EXCLUDE_COUNTRY_CODES" '
            /#EXTINF/ {
                header = $0;
                i = 1; 
                next;
            }
            /http/ && i == 1 {
                # Criterio 1: EXCLUSIÓN por Grupo
                if (header ~ "group-title=\"" exclude_groups) {
                    i = 0;
                    next;
                }
                
                # Criterio 2: EXCLUSIÓN por País No-Latino
                # Si el encabezado contiene CUALQUIER código de país de la lista de exclusión (el mundo), se salta.
                if (header ~ exclude_countries "@") {
                    i = 0;
                    next;
                }
                
                # Criterio 3: INCLUSIÓN (Si pasó los dos filtros de exclusión, se asume que es LATAM y se imprime)
                print header;
                print $0;
                
                i = 0;
            }' "$INPUT_FILE" >> $TEMP_FILTER_FILE

          # 4. SOBREESCRIBIR el archivo final
          echo "# Sobrescribiendo archivo de destino final..."
          mv $TEMP_FILTER_FILE $DEST_FILE
          
      - name: Limpieza de Archivos Temporales
        run: |
          echo "## Eliminando archivos temporales..."
          rm -f lista_completa_original.m3u
          rm -f latam_temp.m3u
          
      - name: Subir solo el Archivo Final (latam.m3u)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Actualización automática: Lista LATAM por exclusión global de países."
          files_to_add: latam.m3u
          file_pattern: 'latam.m3u'
