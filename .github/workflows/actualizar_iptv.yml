- name: Descargar, Filtrar y Generar Archivo Final (Método de INCLUSIÓN)
        run: |
          # ----------------------------------------------------------------------
          DEST_FILE="latam.m3u"
          TEMP_FILTER_FILE="latam_temp.m3u"
          INPUT_FILE="lista_completa_original.m3u"
          # ----------------------------------------------------------------------
          
          # 1. DESCARGAR FUENTE
          echo "# Descargando lista fuente..."
          curl -s "https://iptv-org.github.io/iptv/index.m3u" > $INPUT_FILE

          # 2. CONFIGURAR FILTROS Y ENCABEZADO
          echo "# Aplicando filtros por inclusión..."
          echo "#EXTM3U" > $TEMP_FILTER_FILE
          
          # Lista de códigos de país que QUEREMOS MANTENER (LATAM y US)
          INCLUDE_CODES='mx|ar|co|cl|pe|ec|ve|bo|py|uy|cr|pa|gt|hn|ni|sv|cu|do|pr|us'

          # 3. FILTRAR y ESCRIBIR en Temporal (Ahora buscamos COINCIDENCIAS)
          awk -v include_codes="$INCLUDE_CODES" '
            /#EXTINF/ {
                header = $0;
                i = 1; 
                next;
            }
            /http/ && i == 1 {
                # Si el encabezado SÍ contiene un código de país BUENO (@mx, @us, etc.), se imprime.
                if (header ~ include_codes "@") {
                    print header;
                    print $0;
                }
                i = 0;
            }' "$INPUT_FILE" >> $TEMP_FILTER_FILE

          # 4. SOBREESCRIBIR el archivo final (latam.m3u)
          echo "# Sobrescribiendo archivo de destino final..."
          mv $TEMP_FILTER_FILE $DEST_FILE
