name: Actualizacion_IPTV_LATAM
on:
  schedule:
    - cron: '0 0 * * *' 
  workflow_dispatch:

jobs:
  filtrar_y_actualizar:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Descargar, Filtrar y Generar Archivo Final
        run: |
          # Variables de archivo
          DEST_FILE="latam.m3u"
          TEMP_FILTER_FILE="latam_temp.m3u"
          INPUT_FILE="lista_completa_original.m3u"
          
          # 1. DESCARGAR FUENTE
          echo "# Descargando lista fuente..."
          curl -s "https://iptv-org.github.io/iptv/index.m3u" > $INPUT_FILE

          # 2. CONFIGURAR FILTROS Y ENCABEZADO
          echo "# Aplicando filtro de Inclusión por Grupo/Región (Más robusto)..."
          echo "#EXTM3U" > $TEMP_FILTER_FILE
          
          # GRUPOS REGIONALES QUE QUEREMOS MANTENER (Américas, donde están LATAM y US)
          INCLUDE_REGIONS='North America|South America|Caribbean|Canada|United States'
          
          # GRUPOS QUE QUEREMOS EXCLUIR ESTRICTAMENTE (Religiosos, Compras, etc.)
          EXCLUDE_GROUPS='Religious|Shopping|Sales|Infomercial|Adult|Unknown|Geolocked|Arabic|Indian|Pakistani|Australian|Asian|Russian|Turkish|European|XX|News|Sports|VOD|Music'
          
          # 3. FILTRAR y ESCRIBIR en Temporal (Doble Lógica de Región)
          awk -v include_regions="$INCLUDE_REGIONS" -v exclude_groups="$EXCLUDE_GROUPS" '
            /#EXTINF/ {
                header = $0;
                i = 1; 
                next;
            }
            /http/ && i == 1 {
                # Criterio 1: EXCLUSIÓN por Grupo Específico (Bloquea ventas, religión, música, etc.)
                if (header ~ "group-title=\"" exclude_groups) {
                    i = 0;
                    next;
                }
                
                # Criterio 2: INCLUSIÓN por Región Geográfica (Solo si está en América)
                if (header ~ "group-title=\"" include_regions) {
                    print header;
                    print $0;
                }
                i = 0;
            }' "$INPUT_FILE" >> $TEMP_FILTER_FILE

          # 4. SOBREESCRIBIR el archivo final
          echo "# Sobrescribiendo archivo de destino final..."
          mv $TEMP_FILTER_FILE $DEST_FILE
          
      - name: Limpieza de Archivos Temporales
        run: |
          echo "## Eliminando archivos temporales..."
          rm -f lista_completa_original.m3u
          rm -f latam_temp.m3u
          
      - name: Subir solo el Archivo Final (latam.m3u)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Actualización automática: Lista LATAM+US filtrada y limpia."
          files_to_add: latam.m3u
          file_pattern: 'latam.m3u'
